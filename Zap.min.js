/**
 * Zap! - HTML5 Sound Manager
 * Copyright (c) 2011 Tom Moor
 * MIT Licensed
 */

var Zap=(function(){var k={},sounds={},groups={},loaded=0,timeout=6*1000,self=this,options={container:'sounds',console:true,complete:function(){},error:function(){},update:function(){}};k.formats={};k.init=function(a){options=$.extend(options,a);var b=document.createElement('div');b.setAttribute('id',options.container);document.body.appendChild(b);return this}k.addGroup=function(a,b){groups[a]=b;return this}k.addSound=function(a,b,d,e){var d=d||1;var f=a;sounds[a]={asset:'#'+a,loaded:false,failed:false,duration:0,channels:d,channel:0}var g=setTimeout(function(){p('Zap: sound failed to load: '+a);sounds[a].failed=true;o();options.error(a)},e||timeout);$('<div/>',{'id':a}).appendTo('#'+options.container);var c;while(d--){c='sound-'+f+'-'+d;$('<audio/>',{'id':c,'preload':'auto','autobuffer':true}).appendTo('#'+a);$('#'+c).bind('canplaythrough',function(){clearTimeout(g);sounds[a].loaded=true;sounds[a].duration=$(this).get(0).duration*1000;o()});for(var s in b){$('<source/>',{'src':b[s]}).appendTo('#'+c)}}p('Zap: sound added '+a);return this}k.play=function(a,b,d,c){if(groups[a]){var l=groups[a].length-1;var r=Math.round(Math.random()*l);a=groups[a][r]}else if(!sounds[a].loaded){p('Zap: sound with reference "'+a+'" is not loaded');return false}var e=c||function(){};var f=b||1;var g=sounds[a];var h=$('#sounds #'+a+' audio').get(g.channel);p('Zap: playing "'+a+'" on channel '+(g.channel+1));if(g.channel++>=g.channels-1){g.channel=0}h.currentTime=0;h.volume=f;h.play();if(d){var i=0;var j=setInterval(function(){if(++i<d){Zap.play(a,b);return true}clearInterval(j);e()},g.duration)}else{setTimeout(e,g.duration)}return this}k.stop=function(a){var b=$('#sounds #'+a+' audio').each(function(){$(this).get(0).pause()});return this}k.stopAllSounds=function(){$('#sounds audio').each(function(){$(this).get(0).pause()});return this}k.supported=function(){this.formats={};var a=document.createElement('audio');this.formats.mp3=!!(a.canPlayType&&a.canPlayType('audio/mpeg;').replace(/no/,''));this.formats.vorbis=!!(a.canPlayType&&a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,''));this.formats.wav=!!(a.canPlayType&&a.canPlayType('audio/wav; codecs="1"').replace(/no/,''));this.formats.aac=!!(a.canPlayType&&a.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,''));return this.formats}var m=function(){var c=0;for(var i in sounds){c+=sounds[i].channels}return c}var n=function(){return(m()/loaded)*100}var o=function(){loaded++;options.update(n());if(loaded==m())options.complete()}var p=function(){if(window.console&&options.console){window.console.log(Array.prototype.slice.call(arguments))}}return k})();
