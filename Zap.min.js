/**
 * Zap! - HTML5 Sound Manager
 * Copyright (c) 2011 Tom Moor
 * MIT Licensed
 */

var Zap=(function(){var exports={},sounds={},groups={},events={},loaded=0,timeout=6*1000,self=this,options={container:'sounds',console:true};exports.formats={};exports.init=function(opt){options=$.extend(options,opt);var container=document.createElement('div');container.setAttribute('id',options.container);document.body.appendChild(container);return this}exports.on=function(event,callback){if(!events[event])events[event]=[];events[event].push(callback);return this}var trigger=function(event){var callbacks=events[event];for(var c in callbacks){callbacks[c].apply(this,Array.prototype.slice.call(arguments,1))}}exports.addGroup=function(ref,sounds){groups[ref]=sounds;return this}exports.addSound=function(ref,sources,channels,time){var channels=channels||1;var element=ref;sounds[ref]={asset:'#'+ref,loaded:false,failed:false,duration:0,channels:channels,channel:0}var loadTimeout=setTimeout(function(){log('Zap: sound failed to load: '+ref);sounds[ref].failed=true;soundLoaded();trigger('error',ref)},time||timeout);$('<div/>',{'id':ref}).appendTo('#'+options.container);var c;while(channels--){c='sound-'+element+'-'+channels;$('<audio/>',{'id':c,'preload':'auto','autobuffer':true}).appendTo('#'+ref);$('#'+c).bind('canplaythrough',function(){clearTimeout(loadTimeout);sounds[ref].loaded=true;sounds[ref].duration=$(this).get(0).duration*1000;soundLoaded()});for(var s in sources){$('<source/>',{'src':sources[s]}).appendTo('#'+c)}}log('Zap: sound added '+ref);return this}exports.play=function(ref,vol,loops,c){if(groups[ref]){var l=groups[ref].length-1;var r=Math.round(Math.random()*l);ref=groups[ref][r]}else if(!sounds[ref].loaded){log('Zap: sound with reference "'+ref+'" is not loaded');return false}var callback=c||function(){};var volume=vol||1;var sound=sounds[ref];var element=$('#sounds #'+ref+' audio').get(sound.channel);log('Zap: playing "'+ref+'" on channel '+(sound.channel+1));if(sound.channel++>=sound.channels-1){sound.channel=0}element.currentTime=0;element.volume=volume;element.play();if(loops){var count=0;var loopInterval=setInterval(function(){if(++count<loops){Zap.play(ref,vol);return true}clearInterval(loopInterval);callback()},sound.duration)}else{setTimeout(callback,sound.duration)}return this}exports.stop=function(ref){var element=$('#sounds #'+ref+' audio').each(function(){$(this).get(0).pause()});return this}exports.stopAllSounds=function(){$('#sounds audio').each(function(){$(this).get(0).pause()});return this}exports.supported=function(){this.formats={};var a=document.createElement('audio');this.formats.mp3=!!(a.canPlayType&&a.canPlayType('audio/mpeg;').replace(/no/,''));this.formats.vorbis=!!(a.canPlayType&&a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,''));this.formats.wav=!!(a.canPlayType&&a.canPlayType('audio/wav; codecs="1"').replace(/no/,''));this.formats.aac=!!(a.canPlayType&&a.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/,''));return this.formats}var getChannelCount=function(){var c=0;for(var i in sounds){c+=sounds[i].channels}return c}var getPercentageLoaded=function(){return(loaded/getChannelCount())*100}var soundLoaded=function(){loaded++;trigger('update',getPercentageLoaded());if(loaded==getChannelCount())trigger('complete')}var log=function(){if(window.console&&options.console){window.console.log(Array.prototype.slice.call(arguments))}}return exports})();
